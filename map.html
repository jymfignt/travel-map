<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Travel Map Timeline</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<style>
  body, html {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden;
  }
  #map {
    width: 100%;
    height: 100%;
  }
  .year-label {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.6);
    color: white;
    font-size: 1.5em;
    padding: 6px 18px;
    border-radius: 8px;
    font-family: "Segoe UI", sans-serif;
    z-index: 1000;
  }
</style>
</head>
<body>
<div id="map"></div>
<div class="year-label" id="yearLabel">Loading...</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
async function initMap() {
  const map = L.map('map').setView([35, 110], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const response = await fetch('./data/places.json');
  const places = await response.json();

  // 按年份排序（过滤掉没有年份的）
  const validPlaces = places.filter(p => p.year !== null).sort((a, b) => a.year - b.year);
  const allPlaces = [...places]; // 包含没有年份的
  const layers = [];
  const yearLabel = document.getElementById('yearLabel');

  function colorByType(type) {
    return type === 'region' ? 'rgba(0,150,255,0.5)' : '#ff4b4b';
  }

  // 绘制所有点和区域（初始灰色）
  allPlaces.forEach(place => {
    if (place.type === 'region' && place.bounds) {
      const rect = L.rectangle(place.bounds, {
        color: '#999',
        weight: 1,
        fillOpacity: 0.15
      }).addTo(map);
      rect.bindPopup(`<b>${place.name}</b><br>${place.note}`);
      layers.push({ year: place.year, layer: rect, type: 'region' });
    } else {
      const marker = L.circleMarker([place.lat, place.lng], {
        radius: 6,
        color: '#aaa',
        fillOpacity: 0.4
      }).addTo(map);
      marker.bindPopup(`<b>${place.name}</b><br>${place.note}`);
      layers.push({ year: place.year, layer: marker, type: 'point' });
    }
  });

  // 动画播放函数
  async function animateYears() {
    for (const place of validPlaces) {
      const currentYear = place.year;
      yearLabel.textContent = `${currentYear.toFixed(1)} — ${place.name}`;

      // 更新颜色
      layers.forEach(({ year, layer, type }) => {
        if (year !== null && year <= currentYear) {
          layer.setStyle({
            color: colorByType(type),
            fillOpacity: type === 'region' ? 0.5 : 0.8
          });
        } else {
          layer.setStyle({
            color: '#999',
            fillOpacity: 0.15
          });
        }
      });

      // 飞行到当前地点
      map.flyTo([place.lat, place.lng], 6, { duration: 1.5 });
      await new Promise(r => setTimeout(r, 2000)); // 每步停2秒
    }

    // 播放完后展示所有彩色层
    yearLabel.textContent = "All Journeys";
    layers.forEach(({ layer, type }) => {
      layer.setStyle({
        color: colorByType(type),
        fillOpacity: type === 'region' ? 0.5 : 0.8
      });
    });
  }

  animateYears();
}

initMap();
</script>
</body>
</html>
